<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cube Media Player with Spotify</title>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
</head>
<body>

  <h1>Cube Media Player with Spotify</h1>

  <!-- Button to log in with Spotify -->
  <button id="loginButton">Login with Spotify</button>

  <!-- Container for playlists -->
  <div id="playlistsContainer">
    <h2>Your Playlists</h2>
    <ul id="playlists"></ul>
  </div>

  <!-- Audio player controls -->
  <div id="playerControls">
    <button id="playButton">Play</button>
    <button id="pauseButton">Pause</button>
  </div>

  <script>
    // Spotify App Credentials
    const clientId = '46a00692d37c4f1fb34bbb369c0bd7ac';
    const clientSecret = '967a221d12924c158ab3938f372b08d5';
    const redirectUri = 'https://gobblerian.github.io/cube-mediaplayer/';  // Replace with your actual redirect URI

    // Authorization URL for logging in to Spotify
    const authUrl = `https://accounts.spotify.com/authorize?client_id=${clientId}&response_type=code&redirect_uri=${encodeURIComponent(redirectUri)}&scope=user-read-playback-state%20user-modify-playback-state%20user-read-currently-playing%20playlist-read-private%20streaming`;

    // Helper function to extract query parameters from the URL
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    // OAuth flow: Redirect user to login with Spotify
    document.getElementById('loginButton').addEventListener('click', () => {
      window.location.href = authUrl;
    });

    // Check if the URL contains a code (after login)
    const code = getQueryParam('code');
    if (code) {
      // Exchange the code for an access token
      fetch('https://accounts.spotify.com/api/token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Authorization': 'Basic ' + btoa(clientId + ':' + clientSecret)
        },
        body: `grant_type=authorization_code&code=${code}&redirect_uri=${encodeURIComponent(redirectUri)}`
      })
        .then(response => response.json())
        .then(data => {
          const accessToken = data.access_token;
          initializeSpotifyPlayer(accessToken);
          fetchPlaylists(accessToken);
        })
        .catch(error => console.error('Error fetching access token:', error));
    }

    // Initialize the Spotify Web Playback SDK
    function initializeSpotifyPlayer(token) {
      window.onSpotifyWebPlaybackSDKReady = () => {
        const player = new Spotify.Player({
          name: 'Cube Media Player',
          getOAuthToken: cb => { cb(token); },
          volume: 0.5
        });

        // Error handling
        player.addListener('initialization_error', ({ message }) => { console.error(message); });
        player.addListener('authentication_error', ({ message }) => { console.error(message); });
        player.addListener('account_error', ({ message }) => { console.error(message); });
        player.addListener('playback_error', ({ message }) => { console.error(message); });

        // Playback status updates
        player.addListener('player_state_changed', state => { console.log(state); });

        // Ready
        player.addListener('ready', ({ device_id }) => {
          console.log('Ready with Device ID', device_id);
          transferPlaybackHere(device_id, token);

          // Play and pause buttons
          document.getElementById('playButton').addEventListener('click', () => {
            fetch(`https://api.spotify.com/v1/me/player/play?device_id=${device_id}`, {
              method: 'PUT',
              headers: {
                'Authorization': `Bearer ${token}`
              }
            });
          });

          document.getElementById('pauseButton').addEventListener('click', () => {
            fetch(`https://api.spotify.com/v1/me/player/pause?device_id=${device_id}`, {
              method: 'PUT',
              headers: {
                'Authorization': `Bearer ${token}`
              }
            });
          });
        });

        // Connect to the player
        player.connect();
      };
    }

    // Transfer playback to the web player
    function transferPlaybackHere(device_id, token) {
      fetch('https://api.spotify.com/v1/me/player', {
        method: 'PUT',
        body: JSON.stringify({
          "device_ids": [device_id],
          "play": true,
        }),
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
      });
    }

    // Fetch the user's playlists
    function fetchPlaylists(token) {
      fetch('https://api.spotify.com/v1/me/playlists', {
        headers: {
          'Authorization': `Bearer ${token}`,
        },
      })
        .then(response => response.json())
        .then(data => {
          const playlists = data.items;
          const playlistsContainer = document.getElementById('playlists');
          playlistsContainer.innerHTML = '';

          // Display playlists and set up click event to play them
          playlists.forEach(playlist => {
            const listItem = document.createElement('li');
            listItem.textContent = playlist.name;
            listItem.addEventListener('click', () => playPlaylist(playlist.id, token));
            playlistsContainer.appendChild(listItem);
          });
        })
        .catch(error => console.error('Error fetching playlists:', error));
    }

    // Play a selected playlist
    function playPlaylist(playlistId, token) {
      fetch(`https://api.spotify.com/v1/me/player/play`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          context_uri: `spotify:playlist:${playlistId}`
        })
      })
      .catch(error => console.error('Error playing playlist:', error));
    }
  </script>

</body>
</html>
